<!-- workspace_detail.html -->
<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/workspace_detail.css">
    <title>Esto no es trello</title>
</head>
<body>
<div class="topbar">
    <div>
        <span style="font-weight:bold; font-size:1.2em;">Esto No Es Trello</span>
    </div>
    <div class="user-name">
        Hola, <span id="userName">Usuario</span>
    </div>
</div>
<div class="container">
    <nav class="sidebar">
        <a href="#">Tableros</a>
        <a href="#">Plantillas</a>
        <a href="#">Configuración</a>
        <a href="#">Cerrar sesión</a>
    </nav>
    <div class="main-content">
        <div class="board" id="board">
            <!-- Blocks will be loaded here -->
        </div>
    </div>
</div>

<script>
    const blocks = [
        { title: "Pendientes", cards: ["Tarea 1", "Tarea 2", "Tarea 3"] },
        { title: "En Progreso", cards: ["Tarea 4", "Tarea 5"] },
        { title: "Completadas", cards: ["Tarea 6"] }
    ];

    let dragged = { blockIdx: null, cardIdx: null };
    let dropIndicator = document.createElement('div');
    dropIndicator.className = 'card-drop-indicator';

    function clearDropIndicator() {
        if (dropIndicator.parentNode) {
            dropIndicator.parentNode.removeChild(dropIndicator);
        }
    }

    function renderBoard(blocks) {
        const board = document.getElementById('board');
        board.innerHTML = "";
        blocks.forEach((list, blockIdx) => {
            const listDiv = document.createElement('div');
            listDiv.className = 'list';
            listDiv.innerHTML = `<div class="list-title">${list.title}</div>`;

            // Permitir soltar tarjetas en el bloque (al final)
            listDiv.addEventListener('dragover', e => {
                e.preventDefault();
                // Si no hay tarjetas, mostrar el indicador al final
                if (listDiv.querySelectorAll('.card').length === 0) {
                    if (dropIndicator.parentNode !== listDiv) {
                        clearDropIndicator();
                        listDiv.appendChild(dropIndicator);
                    }
                }
            });
            listDiv.addEventListener('dragleave', e => {
                // Solo eliminar si el mouse sale completamente del bloque
                if (!listDiv.contains(e.relatedTarget)) {
                    clearDropIndicator();
                }
            });
            listDiv.addEventListener('drop', e => {
                e.preventDefault();
                clearDropIndicator();
                if (dragged.blockIdx !== null && dragged.cardIdx !== null) {
                    // Si se suelta en el mismo bloque, al final
                    if (dragged.blockIdx === blockIdx) {
                        const [card] = blocks[blockIdx].cards.splice(dragged.cardIdx, 1);
                        blocks[blockIdx].cards.push(card);
                    } else {
                        // Mover entre bloques
                        const [card] = blocks[dragged.blockIdx].cards.splice(dragged.cardIdx, 1);
                        blocks[blockIdx].cards.push(card);
                    }
                    renderBoard(blocks);
                    dragged = { blockIdx: null, cardIdx: null };
                }
            });

            list.cards.forEach((card, cardIdx) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.textContent = card;
                cardDiv.style.cursor = "pointer";
                cardDiv.draggable = true;

                cardDiv.addEventListener('click', () => {
                    alert(`Has hecho clic en: ${card}`);
                });

                cardDiv.addEventListener('dragstart', e => {
                    dragged = { blockIdx, cardIdx };
                    e.dataTransfer.effectAllowed = "move";
                });

                // Permitir soltar sobre una tarjeta específica
                cardDiv.addEventListener('dragover', e => {
                    e.preventDefault();
                    if (dropIndicator.parentNode !== cardDiv.parentNode || dropIndicator.nextSibling !== cardDiv) {
                        clearDropIndicator();
                        cardDiv.parentNode.insertBefore(dropIndicator, cardDiv);
                    }
                });
                cardDiv.addEventListener('dragleave', e => {
                    // Solo eliminar si el mouse sale completamente de la tarjeta
                    if (!cardDiv.contains(e.relatedTarget)) {
                        clearDropIndicator();
                    }
                });
                cardDiv.addEventListener('drop', e => {
                    e.preventDefault();
                    clearDropIndicator();
                    if (dragged.blockIdx !== null && dragged.cardIdx !== null) {
                        // Si se suelta sobre sí misma, no hacer nada
                        if (dragged.blockIdx === blockIdx && dragged.cardIdx === cardIdx) return;

                        const [cardMoved] = blocks[dragged.blockIdx].cards.splice(dragged.cardIdx, 1);
                        // Si es el mismo bloque y la tarjeta destino está después, ajustar el índice
                        let insertIdx = cardIdx;
                        if (dragged.blockIdx === blockIdx && dragged.cardIdx < cardIdx) {
                            insertIdx--;
                        }
                        blocks[blockIdx].cards.splice(insertIdx, 0, cardMoved);
                        renderBoard(blocks);
                        dragged = { blockIdx: null, cardIdx: null };
                    }
                });

                listDiv.appendChild(cardDiv);
            });
            board.appendChild(listDiv);
        });
    }

    renderBoard(blocks);

    const userName = "Juan Pérez";
    document.getElementById('userName').textContent = userName;
    document.title = `Tablero de ${userName}`;
</script>
</body>
</html>